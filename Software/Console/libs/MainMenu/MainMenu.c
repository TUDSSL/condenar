#include "MainMenu.h"
#include "Kernel.h"
#include "TimeKeeper.h"
#include "Kernel_Draw.h"
#include "stdlib.h"
#include "math.h"
#include "FileSystem.h"

void MainMenu_Update();
void MainMenu_Render(k_image* tudelftIcon);

uint8_t SmallTUD_Icon[];

#define USE_JOYSTICKS

#define ANIMATION_SPEED 4.0f //Changes of icon per second
#define APPS_TO_FIT_IN_SCREEN 3
#define APP_ICON_SIZE_PX 74

int32_t currentMainMenuPosition = 0;
float currentMainMenuAnimationPosition = 0;
int32_t currentTransition = 0; //-1 if moving down, 1 if moving up, 0 if not moving
uint32_t lastFrameMillis = 0;

void MainMenuEntryPoint(){
    //currentMainMenuAnimationPosition = 0;
    //currentMainMenuPosition = 0;
    //lastFrameMillis = 0;

	k_image tudelftIcon = GetImageByName("tudelftIcon");

    while(!k_getShouldCurrentAppExit()){
        MainMenu_Update();
        MainMenu_Render(&tudelftIcon);
    }
}

//#define USE_JOYSTICK

void MainMenu_Update(){

    float deltaTime = (millis() - lastFrameMillis)/1000.0f;
    lastFrameMillis = millis();

    k_input_state inputState;
    k_GetInput(&inputState, true);

    uint32_t appCount = 0; 
    k_app** apps = k_getAppList(&appCount);

    if(currentTransition == 0){ //Check the joystick for movement
    #ifdef USE_JOYSTICKS
          if(inputState.joystickX>0 && currentMainMenuPosition < appCount - 1){
            currentTransition = 1;            
        }else if(inputState.joystickX<0 && currentMainMenuPosition > 0){
            currentTransition = -1;        
    #else
        if(inputState.buttonB && currentMainMenuPosition < appCount - 1){
            currentTransition = 1;            
        }else if(inputState.buttonX && currentMainMenuPosition > 0){
            currentTransition = -1;
    #endif
        }else if(inputState.buttonA){ //Request the change to the new app
            k_setNextApp(apps[currentMainMenuPosition]);
            k_setShouldCurrentAppExit(true);
        }
    }

    //Advance the menu item change animation
    if(deltaTime==0) deltaTime=0.1f; //In case the timing isn't working
    currentMainMenuAnimationPosition += currentTransition * ANIMATION_SPEED * deltaTime;

    //If the transition is done, apply it
    if(currentMainMenuAnimationPosition >= 1){
        currentTransition = 0;
        currentMainMenuAnimationPosition = 0;      
        currentMainMenuPosition++;  
        currentMainMenuPosition = currentMainMenuPosition % appCount;
    }else if(currentMainMenuAnimationPosition <= -1){
        currentTransition = 0;
        currentMainMenuAnimationPosition = 0;
        if(currentMainMenuPosition == 0)
            currentMainMenuPosition = appCount - 1;
        else 
            currentMainMenuPosition--;
    }

    
}


bool test=false;
void MainMenu_Render(k_image* tudelftIcon){
    uint32_t appCount = 0; 
    k_app** apps = k_getAppList(&appCount);


    k_BeginScreenUpdate();

    k_draw_Clear(K_COLOR_WHITE);
    

    int spacing = SCREEN_WIDTH_REAL / APPS_TO_FIT_IN_SCREEN;
    int centerPosX = SCREEN_WIDTH_REAL / 2;
    int centerPosY = SCREEN_HEIGHT_REAL / 2 + 40;

    for(int i=0;i<appCount;i++){
        int appOffset = ((i - (int)currentMainMenuPosition) - currentMainMenuAnimationPosition) * spacing;
        int XCoord = centerPosX + appOffset;

        int halfIconSize = APP_ICON_SIZE_PX / 2;
	
        if(i>currentMainMenuPosition+currentMainMenuAnimationPosition+2) continue;
        if(i<currentMainMenuPosition+currentMainMenuAnimationPosition-2) continue;

        int extraAnimationUpPos= (pow(abs(appOffset/3),1.7)/15);
        
		k_color appBackgroundColor = K_COLOR_RGB(230,230,230);
        //k_draw_FillRectangle(XCoord - halfIconSize, centerPosY - halfIconSize - extraAnimationUpPos, APP_ICON_SIZE_PX, APP_ICON_SIZE_PX, appBackgroundColor);
        k_draw_DrawTextCentered(XCoord,centerPosY + halfIconSize + 2 - extraAnimationUpPos,1,"%s",apps[i]->name);
        if(apps[i]->appIcon!=NULL) k_draw_DrawImage(XCoord-25,centerPosY-25-extraAnimationUpPos,50,50,1,apps[i]->appIcon);
		if(apps[i]->appIconImage.ready) k_draw_DrawImageGeneric(&apps[i]->appIconImage, XCoord-32,centerPosY-32-extraAnimationUpPos,1);	
    }    
    k_draw_DrawImageGeneric(tudelftIcon,centerPosX - 64, centerPosY-130,1);

	
    k_EndScreenUpdate(true,true);
}


CHECKPOINT_EXCLUDE_DATA uint8_t MainMenu_Icon[] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xc0, 0xff, 0xff, 0xfe, 0x1f, 0xe0, 0x3f, 0xc0, 0xff, 0xff, 0xfc, 0x0f, 0xe0, 0x1f, 
	0xc0, 0xff, 0xff, 0xf8, 0x07, 0xe0, 0x1f, 0xc0, 0xff, 0xff, 0xf0, 0x03, 0xe0, 0x1f, 0xc0, 0xff, 
	0xff, 0xc0, 0x00, 0xe0, 0x1f, 0xc0, 0xff, 0xff, 0x80, 0x00, 0x60, 0x1f, 0xc0, 0xff, 0xff, 0x00, 
	0xc0, 0x20, 0x1f, 0xc0, 0xff, 0xfe, 0x01, 0xf0, 0x00, 0x1f, 0xc0, 0xff, 0xfc, 0x07, 0xb8, 0x00, 
	0x1f, 0xc0, 0xff, 0xf0, 0x0e, 0x1c, 0x00, 0x1f, 0xc0, 0xff, 0xe0, 0x1c, 0x0e, 0x00, 0x1f, 0xc0, 
	0xff, 0xc0, 0x38, 0x07, 0x00, 0x1f, 0xc0, 0xff, 0x80, 0x70, 0x03, 0xc0, 0x1f, 0xc0, 0xff, 0x01, 
	0xe0, 0x01, 0xe0, 0x1f, 0xc0, 0xfc, 0x03, 0x80, 0x00, 0x70, 0x0f, 0xc0, 0xf8, 0x07, 0x00, 0x00, 
	0x38, 0x07, 0xc0, 0xf0, 0x0e, 0x00, 0x00, 0x1c, 0x03, 0xc0, 0xe0, 0x1c, 0x00, 0x00, 0x0e, 0x01, 
	0xc0, 0xc0, 0x70, 0x00, 0x00, 0x03, 0x80, 0xc0, 0x00, 0xe0, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x01, 
	0xc0, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x83, 0x80, 0x00, 0x00, 0x00, 0x70, 0x40, 0xcf, 0x00, 0x00, 
	0x00, 0x00, 0x3c, 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x00, 
	0x1f, 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 
	0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 
	0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 
	0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 
	0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 
	0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 0xf8, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x07, 
	0xf8, 0x00, 0x1f, 0xc0, 0xff, 0x00, 0x07, 0xf8, 0x00, 0x3f, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0
};


CHECKPOINT_EXCLUDE_DATA uint8_t SmallTUD_Icon[] = { //128x50
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xfc, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xfc, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xf8, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xe0, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc1, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x83, 0x07, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x07, 0x07, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x1e, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0x3c, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0x7c, 0x30, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0x7c, 0x60, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfe, 0xff, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 
	0x00, 0x00, 0x03, 0xc0, 0xff, 0xc0, 0x7f, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xe3, 0xfe, 0x0f, 0xff, 
	0x00, 0x00, 0x03, 0xc0, 0xff, 0xc0, 0x7f, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe3, 0xfc, 0x0f, 0xff, 
	0x00, 0x00, 0x03, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xc0, 0xff, 0xff, 0xff, 0xe3, 0xf8, 0xff, 0xff, 
	0x00, 0x00, 0x03, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xf0, 0x7f, 0xff, 0xff, 0xe3, 0xf8, 0xff, 0xcf, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xfc, 0x3f, 0xff, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xfe, 0x3f, 0xff, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xfe, 0x1f, 0xff, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1f, 0xf0, 0x7f, 0xe3, 0xc0, 0x1c, 0x0f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1f, 0xe0, 0x0f, 0xe3, 0xc0, 0x0c, 0x00, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1f, 0x8f, 0x87, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x0f, 0x9f, 0xc7, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x8f, 0x1f, 0xe3, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x8f, 0x3f, 0xe3, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x0f, 0x3f, 0xe3, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1f, 0x00, 0x03, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1e, 0x00, 0x03, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0x7f, 0x1f, 0xff, 0x1e, 0x3f, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0x7f, 0xc0, 0xff, 0x1f, 0xfe, 0x1f, 0x3f, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xc0, 0x7f, 0x80, 0xff, 0x1f, 0xfe, 0x3f, 0x3f, 0xff, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xe0, 0x3f, 0x00, 0xff, 0x1f, 0xfc, 0x3f, 0x1f, 0xe3, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xe0, 0x00, 0x01, 0xff, 0x1f, 0xf0, 0x7f, 0x1f, 0xe3, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xf0, 0x00, 0x03, 0xff, 0x1f, 0x80, 0xff, 0x8f, 0xc7, 0xe3, 0xf8, 0xff, 0x8f, 
	0xff, 0x03, 0xff, 0xf8, 0x00, 0x07, 0xff, 0x00, 0x01, 0xff, 0x87, 0x87, 0xe3, 0xf8, 0xff, 0x87, 
	0xff, 0x03, 0xff, 0xff, 0x00, 0x1f, 0xff, 0x00, 0x0f, 0xff, 0xe0, 0x1f, 0xe3, 0xf8, 0xff, 0xc1, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};