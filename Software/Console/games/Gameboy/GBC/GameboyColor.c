#include "GameboyColor.h"
#include "Kernel.h"
#include "TimeKeeper.h"
#include "Kernel_Draw.h"
#include "Helpers/Misc.h"
#include "stdlib.h"
#include "Cartridge.h"
#include "Kernel.h"
#include "Display.h"
#include "Helpers/PinDefinitions.h"
#include "Helpers/UART.h"
#include "Helpers/FileSystem.h"

#include "gb.h"
#include <math.h>

void GameboyColor_Update();
void GameboyColor_Render();

void gb_cart_unload(struct gb *gb);

struct gb dbcData; 
CHECKPOINT_EXCLUDE_BSS uint32_t GBCCrankLastTimeDirection = 0;

void GameboyColorEntryPoint(){
	
	LOG_I("Starting GBC emulator...\n");

	if(k_getHeapSize() < (0x8000 + 0x7f + 0x4000)){
		LOG_E("Not enough memory to run GBC emulator!\n");
		return;
	}

	uint8_t* romPtr;
	if(!ShowFileSelection(GBC | GB, &romPtr, NULL, NULL, NULL)) return;

	dbcData.iram = k_getHeapPtr(); //[0x8000];
	dbcData.zram = dbcData.iram+0x8000; //[0x7f];
	dbcData.vram = dbcData.zram+0x7f; //[0x4000];
	uint8_t* storageRAM = dbcData.vram+0x4000; //[0x2000];
	gb_cart_load(&dbcData, romPtr, storageRAM, k_getHeapSize() - (uint32_t)storageRAM);
	gb_sync_reset(&dbcData);
	gb_irq_reset(&dbcData);
	gb_cpu_reset(&dbcData);
	gb_gpu_reset(&dbcData);
	gb_input_reset(&dbcData);
	gb_dma_reset(&dbcData);
	gb_timer_reset(&dbcData);

	dbcData.iram_high_bank = 1;
	dbcData.vram_high_bank = false;
	dbcData.double_speed = false;
	dbcData.speed_switch_pending = false;
	
	//gamescreen_read_battery(game); //Write save data

    while(!k_getShouldCurrentAppExit()){
        GameboyColor_Update();
    }

	LOG_I("Shutting down GBC emulator...\n");
	gb_cart_unload(&dbcData);	
}

void GBOnCheckpointRestore(){

}

void GameboyColor_Update(){
	k_input_state state;
	k_GetInput(&state, true);
	if(state.buttonB && state.triggerLeft && state.triggerRight){
		//k_setShouldCurrentAppExit(true);
	}    

	//Find the direction with the highest magnitude
	if(fabs(state.joystickY) > fabs(state.joystickX)){
		gb_input_set(&dbcData, GB_INPUT_RIGHT, false);
		gb_input_set(&dbcData, GB_INPUT_LEFT, false);
		gb_input_set(&dbcData, GB_INPUT_UP, state.joystickY>0);
		gb_input_set(&dbcData, GB_INPUT_DOWN, state.joystickY<0);
	}else{
		gb_input_set(&dbcData, GB_INPUT_RIGHT, state.joystickX>0);
		gb_input_set(&dbcData, GB_INPUT_LEFT, state.joystickX<0);
		gb_input_set(&dbcData, GB_INPUT_UP, false);
		gb_input_set(&dbcData, GB_INPUT_DOWN, false);
	}
	
	gb_input_set(&dbcData, GB_INPUT_A, state.buttonA);
	gb_input_set(&dbcData, GB_INPUT_B, state.buttonB);

	if(k_GetSettingBool("/GBC/Use crank as A-B input", false) && k_IsBeingCranked()){
		if(millis()-GBCCrankLastTimeDirection > 800){
			if(k_GetCrankDirection()){
				gb_input_set(&dbcData, GB_INPUT_A, 1);
			}else{
				gb_input_set(&dbcData, GB_INPUT_B, 1);
			}
			GBCCrankLastTimeDirection = millis();
		}else{

			gb_input_set(&dbcData, GB_INPUT_A, 0);
			gb_input_set(&dbcData, GB_INPUT_B, 0);
		}
	}

	if(k_GetSettingBool("/Experiments/Pause enabled",true)){
       gb_input_set(&dbcData, GB_INPUT_START, state.buttonY);
    }else{
	   gb_input_set(&dbcData, GB_INPUT_START, 0);
	}
	
	gb_input_set(&dbcData, GB_INPUT_SELECT, state.triggerLeft);
	

	//LOG_I("Starting GBC CPULoop...");
	gb_cpu_run_cycles(&dbcData, GB_CPU_FREQ_HZ/40);	   
	//LOG_I("Ended GBC CPULoop");
}


void GameboyColor_RenderFrame(){

}


CHECKPOINT_EXCLUDE_DATA uint8_t GameboyColor_Icon[] = {
	0xff, 0xc0, 0x00, 0x00, 0x00, 0xff, 0xc0, 0xff, 0x80, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0xff, 0x00, 
	0x00, 0x00, 0x00, 0x3f, 0xc0, 0xff, 0x1f, 0xff, 0xff, 0xfe, 0x3f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 
	0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 0x3c, 0x00, 0x00, 0x0f, 0x1f, 
	0xc0, 0xfe, 0x38, 0x00, 0x00, 0x07, 0x1f, 0xc0, 0xfe, 0x38, 0x00, 0x00, 0x07, 0x1f, 0xc0, 0xfe, 
	0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 
	0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 
	0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 
	0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 
	0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0xff, 0xff, 
	0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0x00, 0x00, 0x07, 0x1f, 0xc0, 0xfe, 0x38, 0x00, 0x00, 0x07, 0x1f, 
	0xc0, 0xfe, 0x3c, 0x00, 0x00, 0x0f, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 
	0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 0x00, 0x00, 
	0x00, 0x00, 0x1f, 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 
	0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 
	0xfe, 0x3f, 0xbf, 0xff, 0x7f, 0x1f, 0xc0, 0xfe, 0x3f, 0x1f, 0xfe, 0x3f, 0x1f, 0xc0, 0xfe, 0x3f, 
	0x1f, 0xfe, 0x3f, 0x1f, 0xc0, 0xfe, 0x3c, 0x07, 0xfb, 0xef, 0x1f, 0xc0, 0xfe, 0x38, 0x03, 0xf1, 
	0xc7, 0x1f, 0xc0, 0xfe, 0x38, 0x03, 0xf1, 0xc7, 0x1f, 0xc0, 0xfe, 0x3f, 0x1f, 0xff, 0x7f, 0x1f, 
	0xc0, 0xfe, 0x3f, 0x1f, 0xfe, 0x3f, 0x1f, 0xc0, 0xfe, 0x3f, 0x1f, 0xfe, 0x3f, 0x1f, 0xc0, 0xfe, 
	0x3f, 0xfe, 0x1f, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xfc, 0x0f, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xfc, 
	0x0f, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0x1f, 0xc0, 0xfe, 0x3f, 0xff, 0xff, 0xff, 
	0x1f, 0xc0, 0xff, 0x1f, 0xff, 0xff, 0xfe, 0x3f, 0xc0, 0xff, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 
	0xff, 0x80, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0xff, 0xc0, 0x00, 0x00, 0x00, 0xff, 0xc0
};